<!DOCTYPE html>
<html>

    <head>

        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1"> 

        <!--Leaflet CSS-->
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI=" crossorigin=""/>

        <!--Mapbox CSS-->
        <link rel="stylesheet" href="https://api.mapbox.com/mapbox.js/v3.3.1/mapbox.css"/>
         
        <!--Bootstrap CSS-->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">

        <!--Local CSS-->
        <link rel="stylesheet" href="style.css">
         
        <!--Leaflet JS-->
        <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js" integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM=" crossorigin=""></script>
     
        <!--Mapbox JS-->
        <script type="text/javascript" src="https://api.mapbox.com/mapbox.js/v3.3.1/mapbox.js"></script>
     
        <!--Bootstrap JS-->
        <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.3/dist/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
        
        <!--Local JS-->
        <script type="text/javascript" src="map.js"></script>
        
        <!--Paho JS-->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>
        <script type="text/javascript" language="javascript">
            
            function onConnectionLost() {
	            console.log("connection lost");
	            document.getElementById("status").innerHTML="Connection Lost";
	            document.getElementById("messages").innerHTML="Connection Lost";
	            connected_flag=0;
                if(disconnected_flag==0)  {
                    document.getElementById("messages").innerHTML="Connection Lost - Retrying";
                    setTimeout(MQTTconnect, reconnectTimeout);
                }

	        }

	        function onFailure(message) {
		        console.log("Failed");
		        document.getElementById("messages").innerHTML="Connection Failed- Retrying";
                setTimeout(MQTTconnect, reconnectTimeout);
            }
		    
            function onMessageArrived(r_message) {
		        out_msg="Message received "+r_message.payloadString+"<br>";
		        out_msg=out_msg + "Message received Topic "+r_message.destinationName;
		        //console.log("Message received ",r_message.payloadString);
		        console.log(out_msg);
                if(r_message.payloadString.substr(0,9)=='{"name":"'){
                    loc_msg=JSON.parse(r_message.payloadString);
                if(loc_msg['name']!=null && loc_msg['name']=="NewFeatureType"){
                    document.getElementById("messages").innerHTML="Location: "+loc_msg['features'][0]['geometry']['coordinates'][0]+"-"+ "temperture: "+loc_msg['features'][0]['properties']['temp'][0][0];
                geoJsonLocation(loc_msg);
                }
            } else {
                document.getElementById("messages").innerHTML=out_msg;
                }
		    }

	        function onConnected(recon, url) {
	            console.log(" in onConnected "+reconn);
	        }
	        
            function onConnect() {
	            document.getElementById("messages").innerHTML="Connected to "+host+"on port "+port;
	            connected_flag=1;
                document.getElementById("status").innerHTML="Connected";
                console.log("on Connect "+connected_flag);
	        }

            function disconnect() {
                if (connected_flag==1)
                    mqtt.disconnect();
            }

            function MQTTconnect() {
                document.getElementById("messages").innerHTML="";
                var s=document.forms["connform"]["server"].value;
                var p=document.forms["connform"]["port"].value;
                if (p!="") {
                    console.log("ports");
                    port = parseInt(p);
                    console.log("port"+port);
                }
                if (s!="") {
                    host=s;
                    console.log("host");
                }
	            console.log("connecting to "+host+" "+port);
                var x=Math.floor(Math.random() * 10000); 
                var cname="orderform-"+x;
                mqtt=new Paho.MQTT.Client(host, port, cname);
                var options={
                    useSSL: true,
                    timeout: 30,
                    onSuccess: onConnect,
                    onFailure: onFailure,
                
                };
	
            mqtt.onConnectionLost=onConnectionLost;
            mqtt.onMessageArrived=onMessageArrived;

	        mqtt.connect(options);
	        return false;
            }

	        function sub_topics() {
		        document.getElementById("messages").innerHTML="";
                if (connected_flag==0) {
                    out_msg="<b>Not Connected so can't subscribe</b>"
                    console.log(out_msg);
                    document.getElementById("messages").innerHTML=out_msg;
                    return false;
		        }
	            var stopic=document.forms["subs"]["Stopic"].value;
	            console.log("Subscribing to topic ="+stopic);
                document.getElementById("messages").innerHTML="Subscribed to topic ="+stopic;
	            mqtt.subscribe(stopic);
	            return false;
	        }

	        function send_message() {
		        document.getElementById("messages").innerHTML="";
		        if (connected_flag==0){
		            out_msg="<b>Not Connected so can't send</b>"
		            console.log(out_msg);
		            document.getElementById("messages").innerHTML=out_msg;
		            return false;
		        }
		        var msg=document.forms["smessage"]["message"].value;
		        console.log(msg);

		        var topic=document.forms["smessage"]["Ptopic"].value;
		        message=new Paho.MQTT.Message(msg);
		        if (topic=="")
			        message.destinationName="test-topic"
		        else
			        message.destinationName=topic;
		            mqtt.send(message);
		            return false;
	        }

            function send_location() {

                const status=document.querySelector('#loc-status');
                const location=document.querySelector('#location');

                location.href='';
                location.textContent='';

                function success(position) {
                    const latitude=position.coords.latitude;
                    const longitude=position.coords.longitude;

                    status.textContent='';
                    var temperture=Math.floor(Math.random() * 101) - 40;
                    location.textContent=`Latitude: ${latitude} °, Longitude: ${longitude} ° - Temperture: ${temperture} °C`;
            
                    pinLocation(latitude, longitude, temperture);
            
                    if (connected_flag==0) {
                        out_msg="<b>Not Connected so can't send</b>"
                        console.log(out_msg);
                        document.getElementById("loc-status").innerHTML=out_msg;
                        return false;
                    }

                    var geojson={
                        "name": "NewFeatureType",
                        "type": "FeatureCollection",
                        "features": [{
                            "type": "Feature",
                            "geometry": {
                                "type": "Point",
                                "coordinates": []
                            },
                            "properties": {
                            "temp": []
                            }
                        }]
                    };

                    geojson.features[0].geometry.coordinates.push([latitude, longitude]);
                    geojson.features[0].properties.temp.push([temperture]);
                    var msg=JSON.stringify(geojson);
                    console.log(msg);

                    var topic="651/Pui_Ling_IP/my_temperature";
                    message=new Paho.MQTT.Message(msg);
                    if (topic=="")
                        message.destinationName="test-topic"
                    else
                        message.destinationName=topic;
                        mqtt.send(message);
                    return false;
                }

                function error() {
                    status.textContent='Unable to retrieve your location';
                }

                if(!navigator.geolocation) {
                    status.textContent='Geolocation is not supported by your browser';
                } else {
                    status.textContent='Locating…';
                    navigator.geolocation.getCurrentPosition(success, error);
                }
	        }
        </script>

        <title>Main Page</title>

    </head>

    <body>

        <!--Define heading-->
        <div id="header">
            <h1>Websockets Using JavaScript MQTT Client</h1>
        </div>
        
        <script type="text/javascript"></script>

        <!--Connect to MQTT-->                    
        <script>
            var connected_flag=0	
            var mqtt;
            var reconnectTimeout=2000;
        </script>

        <!--Display connection status-->   
        <div class="text-center py-2" id="status">Connection Status: Not Connected</div>
            
        <div class="container d-flex justify-content-center text-center" id="form-container">
            <div class="row main">
                <div class="main-login main-center">

                <!--Input server and host name-->
                <form name="connform" action="" onsubmit="return MQTTconnect()">
                    <div class="form-group">
                        <label for="name" class="cols-sm-2 control-label">Server:</label>
                            <div class="input-group">
                                <input id="server-id" class="form-control" type="text" name="server">
                            </div>
                    </div>
                    <div class="form-group">
                        <label for="name" class="cols-sm-2 control-label">Port:</label>
                            <div class="input-group">
                                <input id="port-id" class="form-control" type="text" name="port">
                            </div>
                    </div>
                    <input class="form-control btn btn-success" id="btn-style" type="submit" value="Start">
                    <input class="form-control btn btn-danger" id="btn-style" type="button" name="discon " value="End" onclick="disconnect()">
                </form>
                <hr>
                
                <!--Input subscribe topic-->
                <form name="subs" action="" onsubmit="return sub_topics()">
                    <div class="form-group">
                        <label for="name" class="cols-sm-2 control-label">Subscribe Topic:</label>
                            <div class="input-group">
                                <input class="form-control" type="text" name="Stopic">
                            </div>
                    </div>
                    <input class="form-control btn btn-primary" id="btn-style" type="submit" value="Subscribe">
                </form> 
                <hr>

                <!--Input and publish message-->
                <form name="smessage" action="" onsubmit="return send_message()">
                    <div class="form-group">
                        <label for="name" class="cols-sm-2 control-label">Message:</label>
                            <div class="input-group">
                                <input class="form-control" type="text" name="message">
                            </div>
                    </div> 
                    <div class="form-group">
                        <label for="name" class="cols-sm-2 control-label">Publish Topic:</label>
                            <div class="input-group">
                                <input class="form-control" type="text" name="Ptopic">
                            </div>
                    </div> 
                    <input class="form-control btn btn-primary" id="btn-style" type="submit" value="Submit">
                </form>

                </div>
            </div>
        </div>
        <br>  

        <!--Display message from server-->
        <div class="container d-flex justify-content-center text-center" id="msg-container">
            Messages: &nbsp;<p id="messages"></p>
        </div>
        <br>
        
        <!--Get and publish current location-->
        <div class="container text-center">
            <div class="text-center py-2" id="publish-loc">Publish your location</div>

            <button id="find-me" class="btn btn-primary">Share My Status</button>
            <p id="loc-status"></p>
            <p id="location"></p>
            
            <!--Send location on click-->
            <script>
                const find = document.querySelector('#find-me');
                if(find){
                    find.addEventListener('click', send_location);
                }
            </script>

            <!--Define map container-->
            <div id="mapid"></div>
        
            <script src="map.js"></script>
        </div>

        <script>
            MQTTconnect();
        </script>

    </body>

</html>
